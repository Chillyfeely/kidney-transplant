{% extends 'rebase.html' %} {% block stylesheets %}{% endblock %} {% block
page_content %}
<div class="container">
  <div class="row mb-3">
    <!-- DONOR PARTITION -->
    <div class="col-md-12 col-xl-6">
      <div class="card mb-3">
        <div class="card-header">
          <h3 class="mb-0 text-center"><strong>Donör Bilgileri</strong></h3>
        </div>
        <div class="card-body bg-body-tertiary">
          <form id="donorForm" class="needs-validation" novalidate>
            <div class="container mt-3">
              <h5 class="text-center">Kişisel Bilgiler</h5>
              <div class="row gx-2">
                <!-- Name Field -->
                <div class="col-sm-6 mb-3">
                  <label class="form-label" for="name">Ad</label>
                  <input
                    class="form-control"
                    id="name"
                    type="text"
                    name="name"
                    placeholder="Ad"
                    required
                  />
                  <div class="invalid-feedback">
                    Lütfen donörün adını giriniz.
                  </div>
                </div>
                <!-- Surname Field -->
                <div class="col-sm-6 mb-3">
                  <label class="form-label" for="surname">Soyad</label>
                  <input
                    class="form-control"
                    id="surname"
                    type="text"
                    name="surname"
                    placeholder="Soyad"
                    required
                  />
                  <div class="invalid-feedback">
                    Lütfen donörün soyadını giriniz.
                  </div>
                </div>
                <!-- Birthdate Field -->
                <div class="col-sm-6 mb-3">
                  <label class="form-label" for="birthdate">Doğum Tarihi</label>
                  <input
                    class="form-control"
                    id="birthdate"
                    type="date"
                    name="birthdate"
                    required
                  />
                  <div class="invalid-feedback">
                    Lütfen geçerli bir doğum tarihi giriniz.
                  </div>
                </div>
                <!-- Blood Type Field -->
                <div class="col-sm-6 mb-3">
                  <label class="form-label" for="blood-type">Kan Grubu</label>
                  <select
                    class="form-select"
                    id="blood-type"
                    name="blood-type"
                    required
                  >
                    <option value="" selected disabled>Seçiniz...</option>
                    <option value="A Rh+">A Rh (pozitif)</option>
                    <option value="A Rh-">A Rh (negatif)</option>
                    <option value="B Rh+">B Rh (pozitif)</option>
                    <option value="B Rh-">B Rh (negatif)</option>
                    <option value="AB Rh+">AB Rh (pozitif)</option>
                    <option value="AB Rh-">AB Rh (negatif)</option>
                    <option value="O Rh+">O Rh (pozitif)</option>
                    <option value="O Rh-">O Rh (negatif)</option>
                  </select>
                  <div class="invalid-feedback">
                    Lütfen donörün kan grubunu seçiniz.
                  </div>
                </div>
                <!-- Weight Field -->
                <div class="col-sm-6 mb-3">
                  <label class="form-label" for="weight">Kilo</label>
                  <input
                    class="form-control"
                    id="weight"
                    type="number"
                    name="weight"
                    placeholder="Kilo"
                    required
                  />
                  <div class="invalid-feedback">
                    Lütfen donörün kilosunu giriniz.
                  </div>
                </div>
                <!-- Height Field -->
                <div class="col-sm-6 mb-3">
                  <label class="form-label" for="height">Boy</label>
                  <input
                    class="form-control"
                    id="height"
                    type="number"
                    name="height"
                    placeholder="Boy (cm)"
                    required
                  />
                  <div class="invalid-feedback">
                    Lütfen donörün boyunu giriniz.
                  </div>
                </div>
                <!-- Occupation Field -->
                <div class="col-sm-6 mb-3">
                  <label class="form-label" for="occupation">Meslek</label>
                  <input
                    class="form-control"
                    id="occupation"
                    type="text"
                    name="occupation"
                    placeholder="Meslek"
                    required
                  />
                  <div class="invalid-feedback">
                    Lütfen donörün mesleğini giriniz.
                  </div>
                </div>
                <!-- Relationship Status Field -->
                <div class="col-sm-6 mb-3">
                  <label class="form-label" for="relationship-status"
                    >Akrabalık Durumu</label
                  >
                  <select
                    class="form-select"
                    id="relationship-status"
                    name="relationship-status"
                    required
                  >
                    <option value="" selected disabled>Seçiniz...</option>
                    <option value="0">Akraba Değil</option>
                    <option value="1">
                      Birinci Derece (Eş, anne, baba, çocuk)
                    </option>
                    <option value="2">
                      İkinci Derece (Kardeş, dede, nine, torun)
                    </option>
                    <option value="3">
                      Üçüncü Derece (Amca, hala, dayı, teyze, yeğen)
                    </option>
                  </select>
                  <div class="invalid-feedback">
                    Lütfen donörün akrabalık durumunu seçiniz.
                  </div>
                </div>
                <div class="col-12">
                  <div class="border-bottom border-dashed my-3"></div>
                </div>
              </div>
            </div>
            <!-- HLA-Antijen Bilgileri for Donor -->
            <div class="container mt-3">
              <h5 class="text-center">HLA-Antijen Bilgileri</h5>
              <div
                class="tab-pane preview-tab-pane active"
                role="tabpanel"
                aria-labelledby="antigensA"
                id="antigensA"
              >
                <label for="antigenChoserA">HLA-A Antijenleri</label>
                <select
                  class="form-select js-choice"
                  id="antigenChoserA"
                  multiple="multiple"
                  size="1"
                  name="hla-a-antigen"
                  data-options='{"removeItemButton":true,"placeholder":true}'
                >
                  <option value="">Antijenleri seçiniz...</option>
                </select>
              </div>
              <div
                class="tab-pane preview-tab-pane"
                role="tabpanel"
                aria-labelledby="antigensB"
                id="antigensB"
              >
                <label for="antigenChoserB">HLA-B Antijenleri</label>
                <select
                  class="form-select js-choice"
                  id="antigenChoserB"
                  multiple="multiple"
                  size="1"
                  name="hla-b-antigen"
                  data-options='{"removeItemButton":true,"placeholder":true}'
                >
                  <option value="">Antijenleri seçiniz...</option>
                </select>
              </div>
              <div
                class="tab-pane preview-tab-pane"
                role="tabpanel"
                aria-labelledby="antigensDR"
                id="antigensDR"
              >
                <label for="antigenChoserDR">HLA-DR Antijenleri</label>
                <select
                  class="form-select js-choice"
                  id="antigenChoserDR"
                  multiple="multiple"
                  size="1"
                  name="hla-dr-antigen"
                  data-options='{"removeItemButton":true,"placeholder":true}'
                >
                  <option value="">Antijenleri seçiniz...</option>
                </select>
              </div>
              <div
                class="tab-pane preview-tab-pane"
                role="tabpanel"
                aria-labelledby="antigensDQ"
                id="antigensDQ"
              >
                <label for="antigenChoserDQ">HLA-DQ Antijenleri</label>
                <select
                  class="form-select js-choice"
                  id="antigenChoserDQ"
                  multiple="multiple"
                  size="1"
                  name="hla-dq-antigen"
                  data-options='{"removeItemButton":true,"placeholder":true}'
                >
                  <option value="">Antijenleri seçiniz...</option>
                </select>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!-- PATIENT PARTITION -->
    <div class="col-md-12 col-xl-6">
      <div class="card mb-3">
        <div class="card-header">
          <h3 class="mb-0 text-center"><strong>Hasta Bilgileri</strong></h3>
        </div>
        <div class="card-body bg-body-tertiary">
          <form id="patientForm" class="needs-validation" novalidate>
            <div class="container mt-3">
              <h5 class="text-center">Kişisel Bilgiler</h5>
              <div class="row gx-2">
                <!-- Name Field -->
                <div class="col-sm-6 mb-3">
                  <label class="form-label" for="patient-name">Ad</label>
                  <input
                    class="form-control"
                    id="patient-name"
                    type="text"
                    name="name"
                    placeholder="Ad"
                    required
                  />
                  <div class="invalid-feedback">
                    Lütfen hastanın adını giriniz.
                  </div>
                </div>
                <!-- Surname Field -->
                <div class="col-sm-6 mb-3">
                  <label class="form-label" for="patient-surname">Soyad</label>
                  <input
                    class="form-control"
                    id="patient-surname"
                    type="text"
                    name="surname"
                    placeholder="Soyad"
                    required
                  />
                  <div class="invalid-feedback">
                    Lütfen hastanın soyadını giriniz.
                  </div>
                </div>
                <!-- Birthdate Field -->
                <div class="col-sm-6 mb-3">
                  <label class="form-label" for="patient-birthdate"
                    >Doğum Tarihi</label
                  >
                  <input
                    class="form-control"
                    id="patient-birthdate"
                    type="date"
                    name="birthdate"
                    required
                  />
                  <div class="invalid-feedback">
                    Lütfen geçerli bir doğum tarihi giriniz.
                  </div>
                </div>
                <!-- Blood Type Field -->
                <div class="col-sm-6 mb-3">
                  <label class="form-label" for="patient-blood-type"
                    >Kan Grubu</label
                  >
                  <select
                    class="form-select"
                    id="patient-blood-type"
                    name="blood-type"
                    required
                  >
                    <option value="" selected disabled>Seçiniz...</option>
                    <option value="A Rh+">A Rh (pozitif)</option>
                    <option value="A Rh-">A Rh (negatif)</option>
                    <option value="B Rh+">B Rh (pozitif)</option>
                    <option value="B Rh-">B Rh (negatif)</option>
                    <option value="AB Rh+">AB Rh (pozitif)</option>
                    <option value="AB Rh-">AB Rh (negatif)</option>
                    <option value="O Rh+">O Rh (pozitif)</option>
                    <option value="O Rh-">O Rh (negatif)</option>
                  </select>
                  <div class="invalid-feedback">
                    Lütfen hastanın kan grubunu seçiniz.
                  </div>
                </div>
                <!-- Weight Field -->
                <div class="col-sm-6 mb-3">
                  <label class="form-label" for="patient-weight">Kilo</label>
                  <input
                    class="form-control"
                    id="patient-weight"
                    type="number"
                    name="weight"
                    placeholder="Kilo"
                    required
                  />
                  <div class="invalid-feedback">
                    Lütfen hastanın kilosunu giriniz.
                  </div>
                </div>
                <!-- Height Field -->
                <div class="col-sm-6 mb-3">
                  <label class="form-label" for="patient-height">Boy</label>
                  <input
                    class="form-control"
                    id="patient-height"
                    type="number"
                    name="height"
                    placeholder="Boy (cm)"
                    required
                  />
                  <div class="invalid-feedback">
                    Lütfen hastanın boyunu giriniz.
                  </div>
                </div>
                <!-- Occupation Field -->
                <div class="col-sm-12 mb-3">
                  <label class="form-label" for="patient-occupation"
                    >Meslek</label
                  >
                  <input
                    class="form-control"
                    id="patient-occupation"
                    type="text"
                    name="occupation"
                    placeholder="Meslek"
                    required
                  />
                  <div class="invalid-feedback">
                    Lütfen hastanın mesleğini giriniz.
                  </div>
                </div>
                <div class="col-12">
                  <div class="border-bottom border-dashed my-3"></div>
                </div>
              </div>
            </div>
            <!-- HLA-Antijen Bilgileri for Patient -->
            <div class="container mt-3">
              <h5 class="text-center">HLA-Antijen Bilgileri</h5>
              <div
                class="tab-pane preview-tab-pane active"
                role="tabpanel"
                aria-labelledby="patient-antigensA"
                id="patient-antigensA"
              >
                <label for="patient-antigenChoserA">HLA-A Antijenleri</label>
                <select
                  class="form-select js-choice"
                  id="patient-antigenChoserA"
                  multiple="multiple"
                  size="1"
                  name="hla-a-antigen"
                  data-options='{"removeItemButton":true,"placeholder":true}'
                >
                  <option value="">Antijenleri seçiniz...</option>
                </select>
              </div>
              <div
                class="tab-pane preview-tab-pane"
                role="tabpanel"
                aria-labelledby="patient-antigensB"
                id="patient-antigensB"
              >
                <label for="patient-antigenChoserB">HLA-B Antijenleri</label>
                <select
                  class="form-select js-choice"
                  id="patient-antigenChoserB"
                  multiple="multiple"
                  size="1"
                  name="hla-b-antigen"
                  data-options='{"removeItemButton":true,"placeholder":true}'
                >
                  <option value="">Antijenleri seçiniz...</option>
                </select>
              </div>
              <div
                class="tab-pane preview-tab-pane"
                role="tabpanel"
                aria-labelledby="patient-antigensDR"
                id="patient-antigensDR"
              >
                <label for="patient-antigenChoserDR">HLA-DR Antijenleri</label>
                <select
                  class="form-select js-choice"
                  id="patient-antigenChoserDR"
                  multiple="multiple"
                  size="1"
                  name="hla-dr-antigen"
                  data-options='{"removeItemButton":true,"placeholder":true}'
                >
                  <option value="">Antijenleri seçiniz...</option>
                </select>
              </div>
              <div
                class="tab-pane preview-tab-pane"
                role="tabpanel"
                aria-labelledby="patient-antigensDQ"
                id="patient-antigensDQ"
              >
                <label for="patient-antigenChoserDQ">HLA-DQ Antijenleri</label>
                <select
                  class="form-select js-choice"
                  id="patient-antigenChoserDQ"
                  multiple="multiple"
                  size="1"
                  name="hla-dq-antigen"
                  data-options='{"removeItemButton":true,"placeholder":true}'
                >
                  <option value="">Antijenleri seçiniz...</option>
                </select>
              </div>
              <div class="col-12">
                <div class="border-bottom border-dashed my-3"></div>
              </div>
            </div>
            <!-- Updated Patient LSA Sınıf 1 Block -->
            <div class="container mt-3">
              <h5 class="text-center">LSA Sınıf 1</h5>
              <div class="row gx-2">
                <div class="col-sm-12 mb-3">
                  <label class="form-label" for="lsa1-A">A</label>
                  <select
                    class="form-select js-choice"
                    id="lsa1-A"
                    name="lsa1-A"
                    multiple="multiple"
                    data-options='{"removeItemButton":true,"placeholder":true}'
                  >
                    <option value="">Seçiniz...</option>
                  </select>
                </div>
                <div class="col-sm-12 mb-3">
                  <label class="form-label" for="lsa1-B">B</label>
                  <select
                    class="form-select js-choice"
                    id="lsa1-B"
                    name="lsa1-B"
                    multiple="multiple"
                    data-options='{"removeItemButton":true,"placeholder":true}'
                  >
                    <option value="" >Seçiniz...</option>
                  </select>
                </div>
                <div class="col-sm-12 mb-3">
                  <label class="form-label" for="lsa1-C">C</label>
                  <select
                    class="form-select js-choice"
                    id="lsa1-C"
                    name="lsa1-C"
                    multiple="multiple"
                    data-options='{"removeItemButton":true,"placeholder":true}'
                  >
                    <option value="" >Seçiniz...</option>
                  </select>
                </div>
                <div class="col-12">
                  <div class="border-bottom border-dashed my-3"></div>
                </div>
              </div>
            </div>

            <!-- Updated Patient LSA Sınıf 2 Block -->
            <div class="container mt-3">
              <h5 class="text-center">LSA Sınıf 2</h5>
              <div class="row gx-2">
                <div class="col-sm-12 mb-3">
                  <label class="form-label" for="lsa2-DRB1"
                    >DRB1</label
                  >
                  <select
                    class="form-select js-choice"
                    id="lsa2-DRB1"
                    name="lsa2-DRB1"
                    multiple="multiple"
                    data-options='{"removeItemButton":true,"placeholder":true}'
                  >
                    <option value="" >Seçiniz...</option>
                  </select>
                </div>
                <div class="col-sm-12 mb-3">
                  <label class="form-label" for="lsa2-DQB1"
                    >DQB1</label
                  >
                  <select
                    class="form-select js-choice"
                    id="lsa2-DQB1"
                    name="lsa2-DQB1"
                    multiple="multiple"
                    data-options='{"removeItemButton":true,"placeholder":true}'
                  >
                    <option value="" >Seçiniz...</option>
                  </select>
                </div>
                <div class="col-sm-12 mb-3">
                  <label class="form-label" for="lsa2-DQB2"
                    >DQB2</label
                  >
                  <select
                    class="form-select js-choice"
                    id="lsa2-DQB2"
                    name="lsa2-DQB2"
                    multiple="multiple"
                    data-options='{"removeItemButton":true,"placeholder":true}'
                  >
                    <option value="" >Seçiniz...</option>
                  </select>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!-- END PARTITIONS -->
    <!-- Combined Submit Button -->
    <div class="text-center my-4">
      <button id="submitAll" class="btn btn-primary">Kaydet</button>
    </div>
    <div class="row mb-3">
      <div id="alertPlaceholder"></div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script src="{{ url_for('static', filename='vendors/choices/choices.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendors/prism/prism.js') }}"></script>
<script>
  // Standard antigen population for donor & patient HLA fields
  function populateOptions(selectId, prefix, count) {
    const select = document.getElementById(selectId);
    for (let i = 1; i <= count; i++) {
      const option = document.createElement("option");
      option.value = `${prefix}${i.toString().padStart(2, "0")}`;
      option.textContent = `${prefix}${i.toString().padStart(2, "0")}`;
      select.appendChild(option);
    }
  }
  populateOptions("antigenChoserA", "A*", 99);
  populateOptions("antigenChoserB", "B*", 99);
  populateOptions("antigenChoserDR", "DRB1*", 99);
  populateOptions("antigenChoserDQ", "DQB1*", 99);
  populateOptions("patient-antigenChoserA", "A*", 99);
  populateOptions("patient-antigenChoserB", "B*", 99);
  populateOptions("patient-antigenChoserDR", "DRB1*", 99);
  populateOptions("patient-antigenChoserDQ", "DQB1*", 99);

  // Populate LSA Sınıf selections via a dedicated function
  function populateLSAOptions(selectId, prefix, start, end) {
    const select = document.getElementById(selectId);
    for (let i = start; i <= end; i++) {
      let num = i.toString().padStart(2, "0");
      let value = `${prefix}*${num}`;
      let option = document.createElement("option");
      option.value = value;
      option.textContent = value;
      select.appendChild(option);
    }
  }
  // LSA Sınıf 1 fields
  populateLSAOptions("lsa1-A", "A", 1, 99);
  populateLSAOptions("lsa1-B", "B", 1, 160);
  populateLSAOptions("lsa1-C", "C", 1, 20);
  // LSA Sınıf 2 fields
  populateLSAOptions("lsa2-DRB1", "DRB1", 1, 40);
  populateLSAOptions("lsa2-DQB1", "DQB1", 1, 20);
  populateLSAOptions("lsa2-DQB2", "DQB2", 1, 20);

  // Single combined submit event
  document
    .getElementById("submitAll")
    .addEventListener("click", function (event) {
      event.preventDefault();

      let donorForm = document.getElementById("donorForm");
      let patientForm = document.getElementById("patientForm");
      let donorValid = donorForm.checkValidity();
      let patientValid = patientForm.checkValidity();

      donorForm.classList.add("was-validated");
      patientForm.classList.add("was-validated");
      if (!donorValid || !patientValid) return;

      // Gather donor data
      let donorData = {};
      new FormData(donorForm).forEach((value, key) => {
        donorData[key] = value;
      });

      // Gather patient data
      let patientData = {};
      new FormData(patientForm).forEach((value, key) => {
        patientData[key] = value;
      });

      // Use donor's relationship-status as bond and create a unique pair_id.
      let bond = donorData["relationship-status"];
      donorData["bond"] = bond;
      patientData["bond"] = bond;
      let pairId = crypto.randomUUID
        ? crypto.randomUUID()
        : Date.now().toString();
      donorData["pair_id"] = pairId;
      patientData["pair_id"] = pairId;

      Promise.all([
        fetch("/db/register-donor", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(donorData),
        }).then((response) => response.json()),
        fetch("/db/register-patient", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(patientData),
        }).then((response) => response.json()),
      ])
        .then(([donorResponse, patientResponse]) => {
          showAlert(
            donorResponse.message + "<br>" + patientResponse.message,
            "success"
          );
          donorForm.reset();
          patientForm.reset();
          donorForm.classList.remove("was-validated");
          patientForm.classList.remove("was-validated");
        })
        .catch((error) => {
          console.error("Error:", error);
          showAlert(
            "Bir hata oluştu. Lütfen sayfayı yenileyip tekrar deneyiniz.",
            "danger"
          );
        });
    });

  function showAlert(message, type) {
    const alertPlaceholder = document.getElementById("alertPlaceholder");
    alertPlaceholder.innerHTML = `
      <div class="alert alert-${type} alert-dismissible fade show text-center" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>`;
  }
</script>
{% endblock %}
